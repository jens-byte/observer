name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: observer.megavisor.be
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            source ~/.bashrc 2>/dev/null || source ~/.profile 2>/dev/null || true
            export PATH=$PATH:/usr/bin:/usr/local/bin:/snap/bin

            # Find docker
            DOCKER=$(which docker 2>/dev/null || echo "/snap/bin/docker")
            echo "Using docker at: $DOCKER"

            # Check if it's a git repo, if not, backup and clone fresh
            if [ ! -d "/var/www/observer/.git" ]; then
              echo "Not a git repo, setting up fresh..."
              [ -d "/var/www/observer" ] && mv /var/www/observer /var/www/observer.backup.$(date +%s)
              git clone https://github.com/jens-byte/observer.git /var/www/observer
            fi

            cd /var/www/observer
            git fetch origin
            git reset --hard origin/main

            $DOCKER compose down || true
            $DOCKER compose up --build -d

            echo "Deployed successfully at $(date)"
